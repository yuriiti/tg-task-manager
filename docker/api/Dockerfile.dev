FROM node:22-alpine

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Set working directory
WORKDIR /app

# Copy package files and workspace configuration
COPY package.json pnpm-workspace.yaml ./
COPY pnpm-lock.yaml* ./

# Copy all package.json files first
COPY apps/api/package.json ./apps/api/
COPY packages/types/package.json ./packages/types/
COPY packages/shared/package.json ./packages/shared/
COPY packages/ui/package.json ./packages/ui/

# Copy package source code (needed for workspace dependencies)
COPY packages/types ./packages/types
COPY packages/shared ./packages/shared
COPY packages/ui ./packages/ui

# Install dependencies (without frozen-lockfile in dev mode for flexibility)
RUN if [ -f pnpm-lock.yaml ]; then \
  pnpm install --frozen-lockfile; \
  else \
  pnpm install; \
  fi

# Copy API source code
COPY apps/api ./apps/api

# Expose port
EXPOSE 3000

# Start development server
CMD ["turbo", "run", "dev", "--filter=api"]
