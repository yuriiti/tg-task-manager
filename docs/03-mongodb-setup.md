# MongoDB Setup

## Обзор

MongoDB используется как основная база данных для хранения пользователей и задач. Документ описывает схему данных, индексы и настройки подключения.

## Подключение

### Connection String

Формат строки подключения включает аутентификацию, хост, порт, имя базы данных и источник аутентификации.

### NestJS конфигурация

Конфигурация MongoDB настраивается через @nestjs/config с использованием переменных окружения и опций подключения.

## Схемы данных

### Users Collection

**Схема пользователя:**

Содержит поля: email (уникальный), username, passwordHash, isActive, lastLoginAt, а также автоматические timestamps (createdAt, updatedAt).

**Индексы:**
- `email` - уникальный индекс
- `username` - индекс для поиска

### Tasks Collection

**Схема задачи:**

Содержит поля: userId (ссылка на User), title, description, status (enum), priority (enum), dueDate, tags (массив), а также автоматические timestamps.

**Индексы:**
- `userId` - для быстрого поиска задач пользователя
- `status` - для фильтрации по статусу
- `createdAt` - для сортировки по дате создания
- Составной индекс: `{ userId: 1, status: 1 }` - для запросов с фильтрацией

## Индексы

### Users Collection

Создаются индексы на email (уникальный), username и createdAt для оптимизации запросов.

### Tasks Collection

Создаются индексы на userId, status, createdAt, составные индексы для комбинированных запросов и индекс на tags для поиска по тегам.

## Связи между коллекциями

### User → Tasks (One-to-Many)

Каждый пользователь может иметь множество задач. Связь реализована через `userId` в коллекции Tasks. Используется метод `populate()` для загрузки связанных задач.

### Task → User (Many-to-One)

Каждая задача принадлежит одному пользователю. Связь через `userId`. Используется `populate()` для загрузки данных пользователя с выбором конкретных полей.

## Миграции

Для управления схемой базы данных рекомендуется использовать миграции.

**Структура миграций:**

Миграции организованы в отдельной директории с нумерованными файлами. Каждая миграция содержит функции `up` и `down` для применения и отката изменений.

## Настройки производительности

### Connection Pool

Настраивается размер пула соединений (min/max), время простоя соединений и таймаут выбора сервера.

### Read Preferences

Для read-heavy операций можно использовать secondary nodes с настройкой readPreference.

## Бэкапы

### Ручной бэкап

Используется `mongodump` для экспорта данных и `mongorestore` для импорта. Команды выполняются через docker-compose exec с указанием учетных данных и пути для бэкапа.

## Мониторинг

### Проверка статистики коллекций

Используется метод `stats()` для получения статистики по коллекциям (размер, количество документов, индексы).

### Проверка использования индексов

Используется метод `explain("executionStats")` для анализа выполнения запросов и проверки использования индексов.

## Безопасность

1. **Аутентификация**: Всегда используйте аутентификацию в production
2. **Шифрование**: Используйте TLS для соединений
3. **Роли пользователей**: Создавайте пользователей с минимальными необходимыми правами
4. **Валидация данных**: Используйте Mongoose схемы для валидации на уровне приложения

## Оптимизация запросов

### Использование проекций

Используется метод `select()` для выборки только необходимых полей и `lean()` для получения обычных JavaScript объектов вместо Mongoose документов.

### Пагинация

Реализуется через методы `skip()` и `limit()` с расчетом смещения на основе номера страницы и размера страницы.

### Агрегации для сложных запросов

Используется pipeline агрегации с этапами `$match` для фильтрации и `$group` для группировки данных.
